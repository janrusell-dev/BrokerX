<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>BrokerX WebSocket Test</title>
    <style>
        body { font-family: monospace; background: #000; color: #0f0; padding: 20px; }
        .log { background: #111; padding: 10px; margin: 5px 0; border-left: 3px solid #0f0; }
        .error { border-left-color: #f00; color: #f00; }
        .success { border-left-color: #0f0; color: #0f0; }
        .info { border-left-color: #00f; color: #0af; }
        button { background: #0f0; color: #000; border: none; padding: 10px 20px; margin: 5px; cursor: pointer; }
        button:hover { background: #0a0; }
    </style>
</head>
<body>
    <h1>🔌 BrokerX WebSocket Diagnostic</h1>
    <div>
        <button onclick="testConnection()">Test WebSocket</button>
        <button onclick="testPublish()">Send Test Message</button>
        <button onclick="clearLogs()">Clear Logs</button>
    </div>
    <hr>
    <div id="logs"></div>

    <script>
        let ws = null;
        
        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = 'log ' + type;
            div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            document.getElementById('logs').insertBefore(div, document.getElementById('logs').firstChild);
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }

        function testConnection() {
            if (ws) {
                log('Closing existing connection...', 'info');
                ws.close();
            }

            const url = 'ws://localhost:8080/subscribe?topic=orders';
            log(`Connecting to: ${url}`, 'info');

            try {
                ws = new WebSocket(url);
                log('WebSocket object created', 'success');

                ws.onopen = () => {
                    log('✅ CONNECTED! WebSocket is open!', 'success');
                    log(`ReadyState: ${ws.readyState} (1 = OPEN)`, 'success');
                };

                ws.onmessage = (event) => {
                    log(`📨 Message received: ${event.data}`, 'success');
                    try {
                        const data = JSON.parse(event.data);
                        log(`Parsed: ${JSON.stringify(data, null, 2)}`, 'info');
                    } catch (e) {
                        log(`Could not parse JSON: ${e}`, 'error');
                    }
                };

                ws.onerror = (error) => {
                    log(`❌ ERROR: ${JSON.stringify(error)}`, 'error');
                    log(`ReadyState: ${ws.readyState}`, 'error');
                    log('If readyState is 3 (CLOSED), connection failed before opening', 'error');
                };

                ws.onclose = (event) => {
                    log(`Connection closed. Code: ${event.code}, Reason: ${event.reason}`, 'info');
                    log(`Was clean: ${event.wasClean}`, 'info');
                    
                    // Common close codes
                    const codes = {
                        1000: 'Normal closure',
                        1001: 'Going away',
                        1002: 'Protocol error',
                        1003: 'Unsupported data',
                        1006: 'Abnormal closure (no close frame)',
                        1007: 'Invalid data',
                        1008: 'Policy violation',
                        1009: 'Message too big',
                        1011: 'Server error'
                    };
                    log(`Close code meaning: ${codes[event.code] || 'Unknown'}`, 'info');
                };

                // Check readyState after a delay
                setTimeout(() => {
                    const states = ['CONNECTING', 'OPEN', 'CLOSING', 'CLOSED'];
                    log(`ReadyState after 1s: ${ws.readyState} (${states[ws.readyState]})`, 'info');
                }, 1000);

            } catch (error) {
                log(`❌ Failed to create WebSocket: ${error}`, 'error');
            }
        }

        async function testPublish() {
            log('Publishing test message...', 'info');
            try {
                const response = await fetch('http://localhost:8080/publish', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        topic: 'orders',
                        sender: 'test-html',
                        payload: { message: 'Test from HTML', timestamp: new Date().toISOString() }
                    })
                });
                const data = await response.json();
                log(`✅ Published! Response: ${JSON.stringify(data)}`, 'success');
            } catch (error) {
                log(`❌ Publish failed: ${error}`, 'error');
            }
        }

        // Auto-test on load
        window.onload = () => {
            log('Page loaded. Click "Test WebSocket" to start', 'info');
            log('Make sure backend is running: go run cmd/server/main.go', 'info');
        };
    </script>
</body>
</html>